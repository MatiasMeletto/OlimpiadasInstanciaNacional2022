@inject IDbContextFactory<CodeBluingDbContext> DbFactory
@inject NavigationManager navigationManager
@page "/llamados"

<h1 class="text-center">Llamados lista</h1>
<div class="Centrar container">
@if (llamados is not null)
{
	    <div class="EstiloTabla container"></div>
    <table style="margin: 0 auto;" id="tabla1">
        <thead>
            <tr>
                <th>ID</th>
				<th>Tipo de llamado</th>
				<th>Origen del llamado</th>
				<th>Atendido</th>
				<th>Fecha y hora de origen</th>
				<th>Fecha y hora de atendido</th>
            </tr>
        </thead>
        <tbody>
			@foreach (Llamado l in llamados)
			{
				<tr>
					<td>@l.TipoLlamado.ToString()</td>
					<td>@l.OrigenLlamado.ToString()</td>
					<td>@l.Atendido</td>
					<td>@l.FechaHora</td>
					<td>@l.HoraAtendido</td>
				</tr>
			}
        </tbody>
    </table>
}
else
{
	<label>Cargando...</label>
}
<br>
<br>
	<h5 class="text-decoration-underline">Crear llamado/reporte</h5>
<label> Tipo de llamado</label>
<br>
<select id="selector" @bind="llamado.TipoLlamado">
	<option value="@TipoLlamado.Emergencia">Emergencia</option>
	<option value="@TipoLlamado.Normal">Normal</option>
</select>
<br>
<label> Origen de llamado</label>
<br>
<select id="selector" @bind="llamado.OrigenLlamado">
	<option value="@TipoOrigenLlamado.Banio">Baño</option>
	<option value="@TipoOrigenLlamado.Cama">Cama</option>
</select>
<br>
@if(pacientes is not null)
{
	<label> Paciente</label>
	<br>
	<select id="selector" @bind="llamado.PacienteId">
		@foreach(Paciente p in pacientes)
		{
			<option value="@p.PacienteId">@p.Nombre  @p.Apellido</option>
		}
	</select>
}
<br>
<label>Atendido </label>
<input type="checkbox" @bind="llamado.Atendido" />
<br>
<br>
<button @onclick="SubirLlamado" >Cargar</button>
</div>
@code {
	public class LlamadoViewModel
	{
		public TipoLlamado TipoLlamado { get; set; }
		public TipoOrigenLlamado OrigenLlamado { get; set; }
		public bool Atendido { get; set; }
		public DateTime FechaHora { get; set; }
		public DateTime HoraAtendido { get; set; }
		public int PacienteId { get; set; }
	}

	public LlamadoViewModel llamado { get; set; } = new();
	public Llamado[]? llamados;
	public Paciente[]? pacientes;

	protected override async Task OnInitializedAsync()
	{
		using var db = DbFactory.CreateDbContext();

		llamado.FechaHora = DateTime.Now;
		llamado.HoraAtendido = DateTime.Now;

		llamados = await db.Llamados.ToArrayAsync();
		pacientes = await db.Pacientes.ToArrayAsync();
	}

	public async void SubirLlamado()
	{
		using var db = DbFactory.CreateDbContext();

		Paciente? p = await db.Pacientes.Where(p => p.PacienteId == llamado.PacienteId).SingleOrDefaultAsync();

		if(p is not null)
		{
			Llamado l = new()
			{
				TipoLlamado = llamado.TipoLlamado,
				OrigenLlamado = llamado.OrigenLlamado,
				Atendido = llamado.Atendido,
				FechaHora = llamado.FechaHora,
				HoraAtendido = llamado.HoraAtendido,
				PacienteId = p.PacienteId	
			};

			await db.Llamados.AddAsync(l);
			await db.SaveChangesAsync();
			StateHasChanged();
		}
	}
}